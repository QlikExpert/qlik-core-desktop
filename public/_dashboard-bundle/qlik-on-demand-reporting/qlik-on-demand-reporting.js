/**
 * @license
 * Copyright (c) 2018 S-cubed Aps DK. All rights reserved.
 * 
 * Copyrights licensed under the terms of the MIT license.
 * Original source <https://github.com/bohua/nprinting-sense-on-demand>
 */
define(["jquery","qlik","./js/properties","./js/helpers","text!./css/qlik-on-demand-reporting.css","text!./template/view-main-single.html","text!./template/view-popup.html","qvangular","core.utils/deferred"],function(u,e,t,d,n,o,s,p,l){u("<style>").html(n).appendTo("head");var f,g=e.currApp(),v={export:{},delete:{},download:null};function r(){var n=[];return f.map(function(e){var t,o,r,a;n.push((t=e,o=l(),r=g.field(t.fieldName).getData({rows:t.totalCount}),a=function(){var n=!1,e=r.rows.reduce(function(e,t){return"S"===t.qState&&(n||isNaN(t.qNum)||(n=!0),e.push(n?t.qNum:t.qText)),e},[]);o.resolve({fieldName:t.fieldName,selectedCount:t.selectedCount,selectedValues:e,isNumeric:n}),r.OnData.unbind(a)},r.OnData.bind(a),o.promise))}),l.all(n)}function m(e){var a=e.conn,i=e.report,s=e.format,c=l();return v.export[i]?c.reject({message:"",status:1}):i&&s?(v.export[i]=!0,r().then(function(r){if(!a.server)throw"Server Connection is not specified";var e=[];if(!a.id){if(!a.app)throw"App is not specified";e.push(d.getConnections(a.server,a.app))}return Promise.all(e).then(function(e){var t=e.shift();t&&0<t.length&&(a.id=t[0].id);var n=d.doGetActionURL(a.server,"api/v1/ondemand/requests"),o={type:"report",config:{reportId:i,outputFormat:s},selections:r,connectionId:a.id};return u.ajax({url:n,method:"POST",contentType:"application/json",data:JSON.stringify(o),xhrFields:{withCredentials:!0}}).then(function(){c.resolve()})})}).catch(function(e){c.reject(e)}).finally(function(){delete v.export[i]})):c.reject({message:"Missing template or format",status:400}),c.promise}return{support:{snapshot:!1,export:!1,exportData:!1},definition:t,template:o,controller:["$scope","$element","$interval",function(e,t,n){e.downloadable=!1;var c=e.layout.npsod.conn,l=null;if(e.showDialog=function(){e.object&&1===e.object.getInteractionState()&&e.popupDg()},void 0===e.FirstTime){e.FirstTime=!0;var o="ontouchstart"in document.documentElement?"touchstart":"click";u(t).find("button.lui-button").bind(o,e.showDialog)}var r=u(t).parents(".qv-inner-object"),a=u(t).parents(".qv-object");r.css("background","transparent"),a.css("border","none"),a.find(".lui-icon--expand ").remove();var i=g.selectionState();i.OnData.bind(function(){f=i.selections}),e.popupDg=function(){p.getService("luiDialog").show({template:s,controller:["$scope","$interval",function(n,o){n.disableNewReport=!0,n.stage="",n.loadingMessage="",n.errorMessage="",n.loadingCount=0;var r="";function a(){return d.doGetTasks(c.server,c.app).then(function(e){if(e.data){var t=JSON.stringify(e.data.items);t!==r&&(r=t,n.taskList=e.data.items,n.taskList.some(function(e){return"running"===e.status})?l||(l=o(function(){a()},1e3)):l&&(o.cancel(l),l=null))}}).catch(function(e){s(e)})}function i(e){n.loadingMessage=e,n.stage="loading"}function s(e){0===e.status||404===e.status?(n.disableNewReport=!0,n.errorMessage="Unable to connect to server."):400===e.status?n.errorMessage="Incomplete configuration.":n.errorMessage="Unknown error.",n.go2OverviewStage(!1)}n.go2OverviewStage=function(e){e?(i("Refreshing data..."),a().then(function(){n.stage="overview",n.disableNewReport=!1})):n.stage="overview"},n.go2SelectReportStage=function(){n.errorMessage="",i("Fetching reports..."),d.doGetReportlist(c.server,c.app).then(function(e){n.reportList=e.data,n.stage="selectReport",n.$apply()}).catch(function(e){s(e)})},n.go2selectFormatStage=function(t){i("Fetching formats..."),d.doGetExportFormats(c.server,t.id).then(function(e){n.currReport=t,n.outputFormats=e.data.outputFormats,n.stage="selectFormat",n.$apply()}).catch(function(e){s(e)})},n.exportReport=function(e){i("Initializing report..."),m({conn:c,report:n.currReport.id,format:e}).then(function(){n.go2OverviewStage(!0)}).catch(function(e){s(e)})},n.deleteTask=function(e){if(!v.delete[e.id]){v.delete[e.id]=!0;var t=e.status;e.status="deleting",d.doDeleteTask(c.server,e.id).then(function(){delete v.delete[e.id],a()}).catch(function(){e.status=t,delete v.delete[e.id]})}},n.downloadTask=function(e){v.download!=e&&(v.download=e,d.downloadTask(c.server,e).finally(function(){v.download=null}))},n.cancel=function(){n.close()},i("Connecting..."),d.getLoginNtlm(c.server).then(function(){var e={conn:c,report:c.report,format:c.exportFormat};return i("Initializing report..."),m(e).then(function(){n.go2OverviewStage(!0)})}).catch(function(e){s(e)})}],input:{stage:e.stage},closeOnEscape:!0}).closed.then(function(){l&&(n.cancel(l),l=null)})}}]}});