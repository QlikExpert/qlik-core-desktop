define(["qlik","qvangular","jquery","core.utils/deferred"],function(o,i,s,a){"use strict";return{isServerSet:function(t){return 0<t.npsod.conn.server.length},isAppSet:function(t){return 0<t.npsod.conn.app.length},doGetActionURL:function(t,e){var n=t;return n.trim(),"/"!=n.slice(-1)&&(n+="/"),n+e},getActionURL:function(t,e){return this.doGetActionURL(t.npsod.conn.server,e)},getApps:function(e){var n=this;return n.isServerSet(e)?n.getLoginNtlm(e.npsod.conn.server).then(function(){var t=[];return t.push(s.ajax({url:n.getActionURL(e,"api/v1/apps"),method:"GET",xhrFields:{withCredentials:!0}})),t.push(n.getConnections(e.npsod.conn.server,null)),Promise.all(t).then(function(t){var n=[],e=t.shift(),r=t.shift();return e&&r&&0!=r.length?(e.data.items.forEach(function(e){r.some(function(t){return t.appId===e.id})&&n.push({value:e.id,label:50<e.name.length?e.name.slice(0,47)+"...":e.name})}),n):[]})}):[]},getConnectionIds:function(t){return this.isAppSet(t)?this.getConnections(t.npsod.conn.server,t.npsod.conn.app).then(function(t){return t.map(function(t){return{value:t.id,label:50<t.name.length?t.name.slice(0,47)+"...":t.name}})}):[]},getConnections:function(t,e){var n="api/v1/connections";return e&&(n+="?appId="+e),s.ajax({url:this.doGetActionURL(t,n),method:"GET",xhrFields:{withCredentials:!0}}).then(function(t){var e=[],n=o.currApp(this),r=new RegExp(".+appid="+n.id+";.+");return t.data.items.forEach(function(t){r.test(t.connectionString)&&e.push(t)}),e})},doGetReportlist:function(t,e){var n=this.doGetActionURL(t,"api/v1/reports?sort=+title&appId="+e);return s.ajax({url:n,method:"GET",xhrFields:{withCredentials:!0}})},getReports:function(t){return this.isServerSet(t)&&this.isAppSet(t)?this.doGetReportlist(t.npsod.conn.server,t.npsod.conn.app).then(function(t){return t.data.items.map(function(t){return{value:t.id,label:50<t.title.length?t.title.slice(0,47)+"...":t.title}})}):[]},doGetExportFormats:function(t,e){var n=this.doGetActionURL(t,"api/v1/reports/"+e);return s.ajax({url:n,method:"GET",xhrFields:{withCredentials:!0}})},getExportFormats:function(t){return 0==this.isServerSet(t)||t.npsod.conn.report.length<1?[]:this.doGetExportFormats(t.npsod.conn.server,t.npsod.conn.report).then(function(t){return t.data.outputFormats.map(function(t){return{value:t,label:t.toUpperCase()}})})},getLoginNtlm:function(e,n){n||(n=0);var r=this;return s.ajax({url:r.doGetActionURL(e,"api/v1/login/ntlm"),method:"GET",xhrFields:{withCredentials:!0}}).catch(function(t){if(401===t.status||403===t.status){if(!(3<n))return r.getLoginNtlm(e,++n);i.getService("qvAlertDialog").show({title:"Unauthorized",message:"User could not be authenticated.",closeOnEscape:!1})}throw t})},doGetTasks:function(t,e){var n=a();if(!e)return n.reject({message:"Must specify app",status:400}),n.promise;var r=this.doGetActionURL(t,"api/v1/ondemand/requests?sort=-created&appId="+e);return s.ajax({url:r,method:"GET",xhrFields:{withCredentials:!0},success:function(t){n.resolve(t)},error:function(t){n.reject(t)}}),n.promise},doDeleteTask:function(t,e){var n=this.doGetActionURL(t,"api/v1/ondemand/requests/"+e);return s.support.cors=!0,s.ajax({url:n,headers:{"access-control-allow-headers":"content-type"},method:"DELETE",xhrFields:{withCredentials:!0}})},downloadTask:function(t,e){var n=this.doGetActionURL(t,"api/v1/ondemand/requests/"+e+"/result"),r=a();return navigator.vendor&&-1<navigator.vendor.indexOf("Apple")||/(Trident|MSIE)/.test(navigator.userAgent)?(window.open(n),r.resolve()):s("#download").on("load",function(){r.resolve()}).attr("src",n),r.promise}}});