/**
 * @license
 * Copyright (c) 2017 Masaki Hamano. All rights reserved.
 * 
 * Copyrights licensed under the terms of the MIT license.
 * Original source <https://github.com/mhamano/Qlik-Sense-Tabs>
 */
define(["jquery","qlik","./properties","css!./css/styles.css"],function(E,B,t,e){var C=B.currApp(this),N=null,k={TAB:'<li class="lui-tab"></li>',TABTEXT:'<span class="lui-tab__text"></span>',TABROW:'<ul class="lui-tabset lui-tabset--fill"></ul>',TABCONTENT:'<article class="tab-contents"></article>',QVOBJECT:'<div class="qvobject viz-without-export"></div>',EXTENSION:'<div qv-extension class="tab-row"></div>',BLOCK:'<div class="tab-block"></div>'};function q(t,e){return t+"-"+e}function w(t,e,n){return t+"_"+e+"-"+n}function I(t,e,n,a,i,r,o){e.append(function(i,t,e,n,a){for(var r=E(k.TABROW),o=t.num_of_tabs,s=null,c=null,l=1;l<=o;l++){var u,p=t["tab"+l].label;u=E(k.TAB).append(E(k.TABTEXT).text(p)).attr("title",p).attr("tabNr",l).attr("panelid",q(i,l)),a&&u.on("click",function(t){var e=E(t.currentTarget),n=e.attr("panelid"),a=E("#"+i);e.siblings().removeClass("lui-active"),e.addClass("lui-active"),a.children("div").removeClass("activated").hide(),a.children("#"+n).addClass("activated").show(),B.resize("#"+n)}),r.append(u),null==s&&(s=u)}return 0<(c=r.find(":nth-child("+e+")")).length?c[0].click():s&&s.click(),r}(n,a,i,0,o)),t.replaceWith(e)}function y(t){t.find(".tab-instructions").remove(),t.find(".tab-contents").remove(),N&&(N.close(),N=null)}return{initialProperties:{version:1,activeTab:1},definition:t,support:{export:!1,exportData:!1,snapshot:!1},paint:function(t,n){var a,i=n.qInfo.qId,e=n.props,r=null,o=t.find('[id^="export-data"]'),s=t.find(".tab-instructions"),c=t.parent(),l=E(k.EXTENSION),u=0<c.find(".tab-row").length,p=1===this._interactionState,d=!0===this.options.noSelections,b=t.find("ul.lui-tabset li.lui-tab.lui-active").attr("tabnr");a=e["tab"+(r=null!=b?b:"1")].export;var h=this.previousState&&(this.previousState.canInteract!==p||this.previousState.noSelections!==d||this.previousState.shouldExport!==a);addExportButton=a&&(h||!this.previousState||this.previousState.currActiveTab!==r),this.previousState={canInteract:p,noSelections:d,currActiveTab:r,shouldExport:a};var f,v,m,T,x,S,g={noInteraction:!p,noSelections:d},_=e["tab"+r].chart,O=w(i,_,r),A=t.find(".tab-contents").attr("chart-id");u?e.num_of_tabs!==c.data("currTabLimit")||h?(c.data("currTabLimit",e.num_of_tabs),t.remove(".lui-tabset"),I(t,l,i,e,r,this.backendApi,p)):(l=c.find(".tab-row"),f=e,c.find(".lui-tab__text").each(function(t,e){var n=E(e),a=n.text(),i=f["tab"+(t+1)].label;a!==i&&n.text(i)})):(c.data("currTabLimit",e.num_of_tabs),I(t,l,i,e,r,this.backendApi,p)),""!==_&&A!==O||h?(y(t),l.append((v=i,m=r,T=_,x=E(k.TABCONTENT),S=E(k.QVOBJECT),x.attr("id",v),x.attr("chart-id",w(v,T,m)),S.attr("id",q(v,m)),x.append(S),x)),C.getObjectProperties(_).then(function(e){return C.getObjectProperties(O).then(function(t){return t}).catch(function(){return C.createGenericObject({qInfo:{qId:O}}).then(function(t){return t.copyFrom(_).then(function(){return t.getProperties().then(function(){return t})})})}).then(function(t){return e.properties.qStateName||(t.properties.qStateName=n.qStateName||""),t.setProperties(t.properties).then(function(){return C.visualization.get(O).then(function(t){return(N=t).show(q(i,r),g).then(function(){o.remove(),a&&t.model.layout.permissions.exportData&&function(e,n,a,t){var i,r=t.find(".tab-contents");i=E("<span/>",{class:"lui-button__icon  lui-icon  lui-icon--export"});var o=E("<button/>",{id:"export-data-"+w(e,a,n),class:"lui-button lui-button lui-button",title:"Export data"}).append(i).on("click touchstart",function(t){t.preventDefault(),C.getObject(null,w(e,a,n),null).then(function(t){new B.table(t).exportData({download:!0})})});r.append(o)}(i,r,_,l)})})})})})):!p&&""===_&&s.length<1&&(y(t),l.append(E("<div/>",{class:"tab-instructions"}).append(E("<div/>",{class:"title",text:"Follow the instructions below to get started:"})).append(E("<ul/>").append(E("<li/>",{text:"Create charts and add them as master items. (You can remove the charts from the sheet after you have added them to master items if you please)"})).append(E("<li/>",{text:'Drag and drop the "Container with tabs" extension onto the sheet.'})).append(E("<li/>",{text:"On the extension property panel, navigate to [Appearance] > [Tabs] Here you can change the number of tabs and assign master items to each tab."}))))),!p&&t.find(".tab-block").length<1?l.append(E(k.BLOCK).on("click touchstart",function(t){return t.preventDefault(),!1})):p&&(t.find(".tab-block").remove(),t.find(".tab-instructions").remove())}}});