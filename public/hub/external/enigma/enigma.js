!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.enigma=t():e.enigma=t()}(this,function(){return function(n){var r={};function i(e){if(r[e])return r[e].exports;var t=r[e]={exports:{},id:e,loaded:!1};return n[e].call(t.exports,t,t.exports,i),t.loaded=!0,t.exports}return i.m=n,i.c=r,i.p="",i(0)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=o(n(1)),i=o(n(4));function o(e){return e&&e.__esModule?e:{default:e}}var s=new r.default,u=new i.default;s.registerService("qix",u.connect.bind(u)),t.default=s,e.exports=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),i=s(n(2)),o=s(n(3));function s(e){return e&&e.__esModule?e:{default:e}}var u=Object.assign||o.default,a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.services=new i.default}return r(e,[{key:"registerService",value:function(e,t){this.services.add(e,t)}},{key:"getService",value:function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=u.apply(void 0,[{}].concat(n));return this.services.get(e)(i)}}]),e}();t.default=a},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();var r=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.entries={}}return n(e,[{key:"add",value:function(e,t){if(e+="",void 0!==this.entries[e])throw new Error("Entry already defined with key "+e);this.entries[e]=t}},{key:"set",value:function(e,t){e+="",this.entries[e]=t}},{key:"remove",value:function(e){delete this.entries[e]}},{key:"get",value:function(e){return this.entries[e]}},{key:"getAll",value:function(){var t=this;return Object.keys(this.entries).map(function(e){return{key:e,value:t.entries[e]}})}},{key:"getKey",value:function(t){var n=this;return Object.keys(this.entries).filter(function(e){return n.entries[e]===t})[0]}},{key:"clear",value:function(){this.entries={}}}]),e}();t.default=r},function(e,t){"use strict";var i=Object.prototype.hasOwnProperty,o=Object.prototype.toString,f=function(e){return"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===o.call(e)},h=function(e){if(!e||"[object Object]"!==o.call(e))return!1;var t,n=i.call(e,"constructor"),r=e.constructor&&e.constructor.prototype&&i.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!n&&!r)return!1;for(t in e);return void 0===t||i.call(e,t)};e.exports=function e(){var t,n,r,i,o,s,u=arguments[0],a=1,c=arguments.length,l=!1;for("boolean"==typeof u?(l=u,u=arguments[1]||{},a=2):("object"!=typeof u&&"function"!=typeof u||null==u)&&(u={});a<c;++a)if(null!=(t=arguments[a]))for(n in t)r=u[n],u!==(i=t[n])&&(l&&i&&(h(i)||(o=f(i)))?(s=o?(o=!1,r&&f(r)?r:[]):r&&h(r)?r:{},u[n]=e(l,s,i)):void 0!==i&&(u[n]=i));return u}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),u=c(n(5)),i=c(n(9)),o=c(n(10)),s=c(n(2)),a=c(n(12));function c(e){return e&&e.__esModule?e:{default:e}}var l=function(){function n(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.sessions=new s.default}return r(n,[{key:"createSession",value:function(e,t,n,r,i,o,s){return new u.default(e,t,n,r,i,o,s)}},{key:"createRPC",value:function(e,t,n,r){return new o.default(e,t,n,r)}},{key:"buildUrl",value:function(e,t){var n=e.unsecure,r=e.host,i=e.port,o=e.prefix,s=e.subpath,u=e.route,a=e.identity,c=e.reloadURI,l="";return l+=n?"ws":"wss",l+="://",l+=r||"localhost",i&&(l+=":"+i),l+=o||"/",s&&(l+=s+"/"),u?l+=u:t&&""!==t&&(l+="app/"+encodeURIComponent(t)),a&&(l+="/identity/"+encodeURIComponent(a)),l+="?reloadUri="+(c?encodeURIComponent(c):"")}},{key:"getSession",value:function(e){var t=this,n=this.buildUrl(e.session,e.appId),r=e.session.disableCache,i=!r&&this.sessions.get(n);if(!i){var o=this.createRPC(e.Promise,n,e.createSocket,e.session);i=this.createSession(o,e.delta,e.schema,e.JSONPatch,e.Promise,e.listeners,e.responseInterceptors),r||(this.sessions.add(n,i),i.on("closed",function(){return t.sessions.remove(n)}))}return i}},{key:"getGlobal",value:function(n,s){var u=this;return n.connect().then(function(){var e={handle:-1,id:"Global",type:"Global",customType:"Global",delta:s.delta},t=n.getObjectApi(e);return t.openApp=t.openDoc=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"",i=4<arguments.length&&void 0!==arguments[4]&&arguments[4];s.session.route="",s.appId=e;var o=u.getSession(s);return o.apiPromise||(o.apiPromise=o.connect().then(function(){return o.send({method:"OpenDoc",handle:-1,params:[e,t,n,r,!!i],delta:!1,outKey:-1})})),o.apiPromise},t}).catch(function(e){throw n.emit("closed",e),e})}},{key:"get",value:function(e,n){return this.getGlobal(e,n).then(function(t){return n.appId?t.openApp(n.appId,n.user,n.password,n.serial,n.noData).then(function(e){return{global:t,app:e}}):{global:t}})}},{key:"connect",value:function(t){n.configureDefaults(t),t.mixins.forEach(function(e){t.schema.registerMixin(e)});var e=this.getSession(t);return this.get(e,t)}}],[{key:"configureDefaults",value:function(e){if(!e.Promise&&"undefined"==typeof Promise)throw new Error("Your environment has no Promise implementation. You must provide a Promise implementation in the config.");e.Promise=e.Promise||Promise,e.session=e.session||{},e.session.host||("undefined"!=typeof location&&"string"==typeof location.hostname?e.session.host=location.hostname:e.session.host="localhost"),e.appId||e.session.route||(e.session.route="app/engineData"),"function"!=typeof e.createSocket&&"function"==typeof WebSocket&&(e.createSocket=function(e){return new WebSocket(e)}),e.schema instanceof i.default||(e.schema=new i.default(e.Promise,e.schema)),e.mixins=e.mixins||[],e.JSONPatch=e.JSONPatch||a.default}}]),n}();t.default=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),c=o(n(6)),l=o(n(8));function o(e){return e&&e.__esModule?e:{default:e}}var s="qReturn",u=Object.prototype.hasOwnProperty,a=function(){function a(e,t,n,r,i){var o=this,s=5<arguments.length&&void 0!==arguments[5]?arguments[5]:{},u=6<arguments.length&&void 0!==arguments[6]?arguments[6]:[];!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),c.default.mixin(this),this.rpc=e,this.delta=t,this.definition=n,this.JSONPatch=r,this.Promise=i,this.apis=new l.default,this.responseInterceptors=[{onFulfilled:this.processErrorInterceptor},{onFulfilled:this.processDeltaInterceptor},{onFulfilled:this.processResultInterceptor},{onFulfilled:this.processOutInterceptor},{onFulfilled:this.processObjectApiInterceptor}],this.responseInterceptors.push.apply(this.responseInterceptors,u),e.on("socket-error",function(e){return o.emit("socket-error",e)}),e.on("closed",function(e){return o.emit("closed",e)}),e.on("notification",function(e){o.emit("notification:*",e.method,e.params),o.emit("notification:"+e.method,e.params)}),e.on("message",function(e){e.change&&e.change.forEach(function(e){return o.emit("handle-changed",e)}),e.close&&e.close.forEach(function(e){return o.emit("handle-closed",e)}),e.suspend&&o.rpc.send({method:"Resume",params:[],handle:e.suspend[0]})}),this.on("handle-changed",function(e){var t=o.apis.getApi(e);t&&t.emit("changed")}),this.on("handle-closed",function(e){var t=o.apis.getApi(e);t&&(t.emit("closed"),o.apis.remove(e))}),this.on("closed",function(){o.removeAllListeners(),o.apis.getApis().forEach(function(e){e.api.emit("closed"),e.api.removeAllListeners()}),o.apis.clear()}),Object.keys(s).forEach(function(e){return o.on(e,s[e])}),this.emit("session-created",this)}return i(a,[{key:"connect",value:function(){return this.rpc.open()}},{key:"send",value:function(e){var t={method:e.method,handle:e.handle,params:e.params,delta:e.delta},n=this.rpc.send(t);e.id=t.id;var r=this.intercept(n,this.responseInterceptors,e);return a.addToPromiseChain(r,"requestId",e.id),r}},{key:"close",value:function(){return this.rpc.close()}},{key:"getObjectApi",value:function(e){var t=e.handle,n=e.id,r=e.type,i=e.customType,o=e.delta,s=void 0===o||o,u=this.apis.getApi(t);return u||(u=this.definition.generate(r).create(this,t,n,s,i),this.apis.add(t,u),u)}},{key:"isPrimitivePatch",value:function(e){return 1===e.length&&-1!==["add","replace"].indexOf(e[0].op)&&this.isPrimitiveValue(e[0].value)&&"/"===e[0].path}},{key:"isPrimitiveValue",value:function(e){return null!=e&&"object"!==(void 0===e?"undefined":r(e))&&!Array.isArray(e)}},{key:"getPatchee",value:function(e,t,n){if(this.isPrimitivePatch(t)){var r=t[0].value;return this.apis.setPatchee(e,n,r),r}var i=this.apis.getPatchee(e,n);return this.isPrimitiveValue(i)||(i=i||(t.length&&Array.isArray(t[0].value)?[]:{}),this.applyPatch(i,t)),this.apis.setPatchee(e,n,i),i}},{key:"applyPatch",value:function(e,t){this.JSONPatch.apply(e,t)}},{key:"intercept",value:function(e,t,n){var r=this;return t.reduce(function(e,t){return e.then(t.onFulfilled&&t.onFulfilled.bind(r,n),t.onRejected&&t.onRejected.bind(r,n))},e)}},{key:"processErrorInterceptor",value:function(e,t){return void 0!==t.error?(this.emit("qix-error",t.error),this.Promise.reject(t.error)):t}},{key:"processDeltaInterceptor",value:function(e,t){var n=t.result;if(t.delta){for(var r=Object.keys(n),i=0,o=r.length;i<o;++i){var s=r[i],u=n[s];if(!Array.isArray(u))return this.Promise.reject("Unexpected rpc response, expected array of patches");n[s]=this.getPatchee(e.handle,u,e.method+"-"+s)}return JSON.parse(JSON.stringify(t))}return t}},{key:"processResultInterceptor",value:function(e,t){return t.result}},{key:"processOutInterceptor",value:function(e,t){return u.call(t,s)?t[s]:-1!==e.outKey?t[e.outKey]:t}},{key:"processObjectApiInterceptor",value:function(e,t){if(t.qHandle&&t.qType){var n={handle:t.qHandle,type:t.qType,id:t.qGenericId,customType:t.qGenericType,delta:this.delta};return this.getObjectApi(n)}return null===t.qHandle&&null===t.qType?null:t}}],[{key:"addToPromiseChain",value:function(e,i,o){e[i]=o;var s=e.then;e.then=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=s.apply(this,t);return a.addToPromiseChain(r,i,o),r}}}]),a}();t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=n(7),o=(r=i)&&r.__esModule?r:{default:r};t.default={mixin:function(t){Object.keys(o.default.prototype).forEach(function(e){t[e]=o.default.prototype[e]}),o.default.init(t)}}},function(e,t){var u={};function r(){r.init.call(this)}u.isObject=function(e){return"object"==typeof e&&null!==e},u.isNumber=function(e){return"number"==typeof e},u.isUndefined=function(e){return void 0===e},u.isFunction=function(e){return"function"==typeof e},((e.exports=r).EventEmitter=r).prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.init=function(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0},r.prototype.setMaxListeners=function(e){if(!u.isNumber(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,n,r,i,o,s;if(this._events||(this._events={}),"error"===e&&!this._events.error)throw(t=arguments[1])instanceof Error?t:Error('Uncaught, unspecified "error" event.');if(n=this._events[e],u.isUndefined(n))return!1;if(u.isFunction(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:for(r=arguments.length,i=new Array(r-1),o=1;o<r;o++)i[o-1]=arguments[o];n.apply(this,i)}else if(u.isObject(n)){for(r=arguments.length,i=new Array(r-1),o=1;o<r;o++)i[o-1]=arguments[o];for(r=(s=n.slice()).length,o=0;o<r;o++)s[o].apply(this,i)}return!0},r.prototype.on=r.prototype.addListener=function(e,t){var n;if(!u.isFunction(t))throw TypeError("listener must be a function");(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,u.isFunction(t.listener)?t.listener:t),this._events[e]?u.isObject(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,u.isObject(this._events[e])&&!this._events[e].warned)&&((n=u.isUndefined(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&0<n&&this._events[e].length>n&&(this._events[e].warned=!0,u.isFunction(console.error)&&console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),u.isFunction(console.trace)&&console.trace()));return this},r.prototype.once=function(e,t){if(!u.isFunction(t))throw TypeError("listener must be a function");var n=!1;function r(){this.removeListener(e,r),n||(n=!0,t.apply(this,arguments))}return r.listener=t,this.on(e,r),this},r.prototype.removeListener=function(e,t){var n,r,i,o;if(!u.isFunction(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(i=(n=this._events[e]).length,r=-1,n===t||u.isFunction(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(u.isObject(n)){for(o=i;0<o--;)if(n[o]===t||n[o].listener&&n[o].listener===t){r=o;break}if(r<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],u.isFunction(n))this.removeListener(e,n);else if(Array.isArray(n))for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){return this._events&&this._events[e]?u.isFunction(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.listenerCount=function(e,t){return e._events&&e._events[t]?u.isFunction(e._events[t])?1:e._events[t].length:0}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),o=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var s=i.get;return void 0!==s?s.call(r):void 0},s=n(2),u=(r=s)&&r.__esModule?r:{default:r};var a=function(e){function r(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(r.__proto__||Object.getPrototypeOf(r)).call(this))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(r,u.default),i(r,[{key:"add",value:function(e,t){var n={api:t,deltaCache:new u.default};return o(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"add",this).call(this,e.toString(),n),n}},{key:"getApi",value:function(e){var t=this.get(e.toString());return t&&t.api}},{key:"getApis",value:function(){return o(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"getAll",this).call(this).map(function(e){return{handle:e.key,api:e.value.api}})}},{key:"getPatchee",value:function(e,t){var n=this.get(e.toString());return n&&n.deltaCache.get(t)}},{key:"addPatchee",value:function(e,t,n){this.get(e.toString()).deltaCache.add(t,n)}},{key:"setPatchee",value:function(e,t,n){this.get(e.toString()).deltaCache.set(t,n)}}]),r}();t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),i=o(n(2)),l=o(n(6));function o(e){return e&&e.__esModule?e:{default:e}}var s=["GetProperties","SetProperties","GetFullPropertyTree","SetFullPropertyTree","GetAppProperties","SetAppProperties"],u=function(){function n(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),this.Promise=e,this.mixins=new i.default,this.def=t,this.types=new i.default}return r(n,[{key:"registerMixin",value:function(e){var n=this,t=e.types,r=e.type,i=e.extend,o=e.override,s=e.init;Array.isArray(t)||(t=[t]),r&&t.push(r);var u={extend:i,override:o,init:s};t.forEach(function(e){var t=n.mixins.get(e);t?t.push(u):n.mixins.add(e,[u])})}},{key:"generate",value:function(e){var t=this.types.get(e);if(t)return t;if(!this.def.structs[e])throw new Error(e+" not found");var n=this.generateApi(e,this.def.structs[e]);return this.types.add(e,n),n}},{key:"generateApi",value:function(a,e){var c=Object.create({});return this.generateDefaultApi(c,e),this.mixinType(a,c),{create:function(e,t,n,r,i){var o=this,s=Object.create(c);l.default.mixin(s),Object.defineProperties(s,{session:{enumerable:!0,value:e},handle:{enumerable:!0,value:t},id:{enumerable:!0,value:n},delta:{enumerable:!0,value:r}});var u=this.mixins.get(a)||[];return i!==a&&(this.mixinType(i,s),u=u.concat(this.mixins.get(i)||[])),u.forEach(function(e){"function"==typeof e.init&&e.init({Promise:o.Promise,api:s})}),s}.bind(this),def:c}}},{key:"generateDefaultApi",value:function(t,n){Object.keys(n).forEach(function(r){var e=r.substring(0,1).toLowerCase()+r.substring(1),i=n[r].Out&&1===n[r].Out.length?n[r].Out[0].Name:-1,o=-1===s.indexOf(r)&&-1!==i&&"qSuccess"!==i;Object.defineProperty(t,e,{enumerable:!0,writable:!0,value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.session.send({method:r,handle:this.handle,params:t,delta:this.delta&&o,outKey:i})}})})}},{key:"mixinType",value:function(s,u){var e=this.mixins.get(s);e&&e.forEach(function(e){var t=e.extend,n=void 0===t?{}:t,r=e.override,o=void 0===r?{}:r;Object.keys(o).forEach(function(r){if("function"!=typeof u[r]||"function"!=typeof o[r])throw new Error("No function to override. Type: "+s+" function: "+r);var i;i=u[r],u[r]=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[r].apply(this,[i.bind(this)].concat(t))}}),Object.keys(n).forEach(function(e){if("function"==typeof u[e]&&"function"==typeof n[e])throw new Error("Extend is not allowed for this mixin. Type: "+s+" function: "+e);u[e]=n[e]})})}}]),n}();t.default=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),o=i(n(6)),s=i(n(11));function i(e){return e&&e.__esModule?e:{default:e}}var u=function(){function i(e,t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),o.default.mixin(this),this.Promise=e,this.url=t,this.createSocket=n,this.sessionConfig=r,this.resolvers={},this.requestId=0,this.openedPromise=void 0}return r(i,[{key:"open",value:function(){var n=this;if(this.openedPromise)return this.openedPromise;try{this.socket=this.createSocket(this.url,this.sessionConfig)}catch(e){return this.Promise.reject(e)}return this.socket.onopen=this.onOpen.bind(this),this.socket.onclose=this.onClose.bind(this),this.socket.onerror=this.onError.bind(this),this.socket.onmessage=this.onMessage.bind(this),this.openedPromise=new this.Promise(function(e,t){return n.registerResolver("opened",e,t)}),this.closedPromise=new this.Promise(function(e,t){return n.registerResolver("closed",e,t)}),this.openedPromise}},{key:"onOpen",value:function(){var e=this;this.resolvers.opened.resolveWith(function(){return e.closedPromise})}},{key:"onClose",value:function(e){this.emit("closed",e),this.resolvers.closed.resolveWith(e),this.rejectAllOutstandingResolvers()}},{key:"close",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1e3,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";return this.socket.close(e,t),this.closedPromise}},{key:"onError",value:function(e){this.resolvers.opened?this.resolvers.opened.rejectWith(e):this.emit("socket-error",e),this.rejectAllOutstandingResolvers()}},{key:"onMessage",value:function(e){var t=JSON.parse(e.data);void 0!==t.id?(this.emit("message",t),this.resolvers[t.id].resolveWith(t)):this.emit(t.params?"notification":"message",t)}},{key:"rejectAllOutstandingResolvers",value:function(){var t=this;Object.keys(this.resolvers).forEach(function(e){"opened"!==e&&"closed"!==e&&t.resolvers[e].rejectWith()})}},{key:"unregisterResolver",value:function(e){this.resolvers[e].removeAllListeners(),delete this.resolvers[e]}},{key:"registerResolver",value:function(e,t,n){var r=this,i=this.resolvers[e]=new s.default(e,t,n);i.on("resolved",function(e){return r.unregisterResolver(e)}),i.on("rejected",function(e){return r.unregisterResolver(e)})}},{key:"send",value:function(n){var r=this;return this.socket&&this.socket.readyState===this.socket.OPEN?(n.jsonrpc="2.0",n.id=++this.requestId,this.socket.send(JSON.stringify(n)),new this.Promise(function(e,t){return r.registerResolver(n.id,e,t)})):this.Promise.reject(new Error("Not connected"))}}]),i}();t.default=u},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r,i=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),o=n(6),s=(r=o)&&r.__esModule?r:{default:r};var u=function(){function r(e,t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,r),s.default.mixin(this),this.id=e,this.resolve=t,this.reject=n}return i(r,[{key:"resolveWith",value:function(e){this.resolve(e),this.emit("resolved",this.id)}},{key:"rejectWith",value:function(e){this.reject(e),this.emit("rejected",this.id)}}]),r}();t.default=u},function(e,t,n){var r,i,o,s;s=function(c){c=c.bind(null,!0);var l={},f=function(e){return null!=e&&!Array.isArray(e)&&"object"==typeof e},h=Array.isArray,p=function(e){return void 0===e},n=function(e){return"function"==typeof e};function d(e,t){return n(e[t])||"$$"===t.substring(0,2)||"_"===t.substring(0,1)}function v(n,e){var r,i=e.substring(1).split("/").slice(0,-1);return i.forEach(function(e,t){t!==i.length&&(n=n[(r=+e)||e]=p(n[r||e])?isNaN(r)?{}:[]:n[e])}),n}function y(t,n){var e,r,i=!0;if(f(t)&&f(n))return Object.keys(t).length===Object.keys(n).length&&(Object.keys(t).forEach(function(e){if(!y(t[e],n[e]))return i=!1}),i);if(h(t)&&h(n)){if(t.length!==n.length)return!1;for(e=0,r=t.length;e<r;e++)if(!y(t[e],n[e]))return!1;return!0}return t===n}return l.generate=function(o,s,u){u=u||"";var a=[];return Object.keys(s).forEach(function(e){var t,n=((t=s[e])&&(t=c({},{val:t}).val),t),r=o[e],i=u+"/"+e;y(n,r)||d(s,e)||(p(r)?a.push({op:"add",path:i,value:n}):f(n)&&f(r)?a=a.concat(l.generate(r,n,i)):h(n)&&h(r)?a=a.concat(function(e,t,n){var r,i,o=[],s=e.slice(),u=-1;function a(e,t,n){if(e[n]&&p(e[n].qInfo))return null;if(e[n]&&e[n].qInfo.qId===t)return n;for(var r=0,i=e.length;r<i;r++)if(e[r]&&e[r].qInfo.qId===t)return r;return-1}if(y(t,s))return o;if(!p(t[0])&&p(t[0].qInfo))return o.push({op:"replace",path:n,value:t}),o;for(r=s.length-1;0<=r;--r)-1===(u=a(t,s[r].qInfo&&s[r].qInfo.qId,r))?(o.push({op:"remove",path:n+"/"+r}),s.splice(r,1)):o=o.concat(l.generate(s[r],t[u],n+"/"+r));for(r=0,i=t.length;r<i;++r)-1===(u=a(s,t[r].qInfo&&t[r].qInfo.qId))?(o.push({op:"add",path:n+"/"+r,value:t[r]}),s.splice(r,0,t[r])):u!==r&&(o.push({op:"move",path:n+"/"+r,from:n+"/"+u}),s.splice(r,0,s.splice(u,1)[0]));return o}(r,n,i)):a.push({op:"replace",path:u+"/"+e,value:n}))}),Object.keys(o).forEach(function(e){p(s[e])&&!d(o,e)&&a.push({op:"remove",path:u+"/"+e})}),a},l.apply=function(a,e){e.forEach(function(e){var t,n=v(a,e.path),r=e.path.split("/").splice(-1)[0],i=r&&isNaN(+r)?n[r]:n[+r]||n,o=e.from?e.from.split("/").splice(-1)[0]:null;if("/"===e.path&&(n=null,i=a),"add"===e.op||"replace"===e.op)if(h(n))"-"===r&&(r=n.length),n.splice(+r,"add"===e.op?0:1,e.value);else if(h(i)&&h(e.value)){var s=e.value.slice();i.length=0,i.push.apply(i,s)}else if(f(i)&&f(e.value))t=i,Object.keys(t).forEach(function(e){Object.getOwnPropertyDescriptor(t,e).configurable&&!d(t,e)&&delete t[e]}),c(i,e.value);else{if(!n)throw new Error("Patchee is not an object we can patch");n[r]=e.value}else if("move"===e.op){var u=v(a,e.from);h(n)?n.splice(+r,0,u.splice(+o,1)[0]):(n[r]=u[o],delete u[o])}else"remove"===e.op&&(h(n)?n.splice(+r,1):delete n[r])})},l.clone=function(e){return c({},e)},l.createPatch=function(e,t,n){var r={op:e.toLowerCase(),path:n};return"move"===r.op?r.from=t:void 0!==t&&(r.value=t),r},l.updateObject=function(e,t){Object.keys(e).length?l.apply(e,l.generate(e,t)):c(e,t)},l},i=[n(3)],void 0===(o="function"==typeof(r=s)?r.apply(t,i):r)||(e.exports=o)}])});